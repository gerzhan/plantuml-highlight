<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link type="text/css" rel="stylesheet" href="styles.css">
    <title>Подсветка для диаграмм сущностей PlantUML</title>
</head>
<body>
    <main>
        <noscript>
            <div class="handicap-msg">
                <p>
                    Инструмент работает на JavaScript. <br>
                    Пожалуйста включите JavaScript.
                </p>
            </div>
        </noscript>
        <h1>Подсветка для диаграмм сущностей PlantUML</h1>
        <section class="upload">
            <div class="controls">
                <input type="file" name="svg-src" class="file">
                <button class="svg-btn">Загрузить диаграмму (SVG)</button>
                <span class="file-name error">Файл не выбран</span>
            </div>
            <textarea name="code" class="code tile" cols="30" rows="10" readonly></textarea>
        </section>
        <section class="view">
            <div class="diagram tile"></div>
            <div class="controls">
                <button class="fit" disabled>Вместить</button>
                <button class="reset" disabled>Сбросить выделение</button>
            </div>
            <ul class="entity-list all-list tile"></ul>
            <ul class="entity-list active-list tile"></ul>
        </section>
    </main>
    <footer>
        <span class="copyright">© 2019 Аксанов К. В.</span>
    </footer>

    <!-- Уведомление о поддержке API -->
    <script>
        if (window.File && window.FileReader && window.FileList && window.Blob) {
        } else {
            var msg = document.createElement("p");
            msg.appendChild(document.createTextNode("Ваш браузер не поддерживает API для работы с файлами. Погуглите."));

            var api_missing_wrapper = document.createElement("div");
            api_missing_wrapper.appendChild(msg);
            api_missing_wrapper.classList.add("handicap-msg");

            document.body.appendChild(api_missing_wrapper);
        }
    </script>

    <!-- 1. Загрузка SVG -->
    <script>
        let LOADING_STR = 'Идет загрузка...';
        let ERROR_STR = 'Ошибка загрузки.';

        let file_input = document.getElementsByClassName('file')[0];
        let svg_btn = document.getElementsByClassName('svg-btn')[0];
        let filename_label = document.getElementsByClassName('file-name')[0];
        let code_area = document.getElementsByClassName('code')[0];
        let diagram_area = document.getElementsByClassName('diagram')[0];
        let entity_lists = Array.from(document.getElementsByClassName('entity-list')).splice(0,2);
        let reader = new FileReader();
        var current_file;
        var diagram_code;
        var svg_text;
        var diagram_svg;

        reader.onloadstart = function(event) {
            code_area.innerText = LOADING_STR;
        };
        reader.onloadend = function(event) {
            // try {
                raw_text = event.target.result;
                diagram_code = get_diagram_code(raw_text);
                svg_text = get_svg(raw_text);

                code_area.innerHTML = diagram_code;
                diagram_area.innerHTML = '';
                diagram_area.appendChild(parse_diagram(diagram_code, svg_text));
                diagram_svg = diagram_area.childNodes[0];
                create_entity_lists();
                fit();
                bind_highlight();
                bind_controls();
            // }
            // catch(err) {
            //     show_error();
            // }
        };
        reader.onerror = show_error;

        file_input.addEventListener('change', select_file, false);
        svg_btn.onclick = function(event) {file_input.click();};

        function create_entity_lists() {
            entity_lists.forEach(init_entity_list);
            entity_lists.forEach(assign_entity_list);
        }

        function init_entity_list(list) {
            list.innerHTML = '';
            for (const [entity, num] of Object.entries(entities_to_num)) {
                var list_item = document.createElement("li");
                list_item.innerHTML = entity;
                list.appendChild(list_item);
                list_item.dataset.num = num;
            }
        }

        function assign_entity_list(list) {
            Array.from(list.children).forEach(function(list_item, index) {
                var classes = Array.from(document.querySelectorAll('.entity[data-num="'+list_item.dataset.num+'"]')[0].classList);
                list_item.classList.add('entity');
                classes.forEach(function(class_item, index) {
                    list_item.classList.add(class_item);
                });
            });
        }

        function select_file(event) {
            current_file = event.target.files[0];
            var output = [];

            size = ((current_file.size/1024).toFixed(2) + ' Кб') || '';
            upd_date = new Date(current_file.lastModified);
            upd_date = current_file.lastModified ? (', ' + upd_date.toLocaleTimeString() + ' - ' + upd_date.toLocaleDateString()) : ''

            output.push(current_file.name + ' (' + size + upd_date +')');

            if (current_file.type != "image/svg+xml") {
                show_error();
            } else {
                hide_error();
                reader.readAsText(current_file);
            }
            filename_label.innerText = output;
        }

        function get_diagram_code(raw_text) {
            raw_text = raw_text.replace(/- -/g, "--");
            raw_text = raw_text.replace(/\. \./g, "..");
            let start_ind = raw_text.indexOf('@startuml');
            let end_ind = raw_text.indexOf('@enduml')+7;
            if (start_ind !== -1 && end_ind !== -1) {
                hide_error();
                return raw_text.substring(start_ind, end_ind);
            } else {
                show_error();
                return ERROR_STR;
            }
        }

        function get_svg(raw_text) {
            let start_ind = raw_text.indexOf('<svg');
            let end_ind = raw_text.indexOf('</svg>')+6;
            if (start_ind !== -1 && end_ind !== -1) {
                hide_error();
                return raw_text.substring(start_ind, end_ind);
            } else {
                show_error();
            }
        }

        function show_error() {
            filename_label.classList.add("error");
            code_area.innerText = ERROR_STR;
            entity_lists.innerHTML = '';
            diagram_area.innerHTML = '';
            fit_btn.setAttribute('disabled', true);
            reset_btn.setAttribute('disabled', true);
        }

        function hide_error() {
            filename_label.classList.remove("error");
            fit_btn.removeAttribute('disabled');
            reset_btn.removeAttribute('disabled');
        }
    </script>

    <!-- 2. Парсинг диаграммы -->
    <script>
        let svg_headers;
        var entities_to_num, num_to_entities;

        function parse_diagram(diagram_code, svg_text) {
            // 0. Получить необходимые заголовки для парсинга DOMParser
            svg_headers = get_svg_headers(svg_text);

            // 1. Узнать имена сущностей и сопоставить с числами (от нуля) - парсинг текста описания диаграммы
            [entities_to_num, num_to_entities] = get_entities(diagram_code);

            // 2. Добавить сущностям числа их имен - парсинг текста svg
            var entities_wrapper = assign_main_nums(entities_to_num, svg_text);

            // 3. Сопоставить связям числа имен сущностей - парсинг текста svg
            var links_wrapper = assign_link_nums(entities_to_num, svg_text);

            // 4. Объединить обертки сущностей и связей
            var diagram_svg = entities_wrapper.children[0];
            diagram_svg.appendChild(links_wrapper.children[0].children[1]);

            return diagram_svg;
        }

        function get_svg_headers(svg_text) {
            return svg_text.match(/<svg.*?<\/defs>/g);
        }

        function get_entities(diagram_code) {
            var reg = new RegExp('(class|entity|enum) [^\{]*', 'g');
            var num_to_entities = Object();
            var entities_to_num = Object();

            diagram_code.match(reg).forEach(function(item, index) {
                var entity = item.replace(/class|entity|enum|\s/g, '');
                num_to_entities['e'+index.toString()] = entity;
                entities_to_num[entity] = 'e'+index.toString();
            });

            return [entities_to_num, num_to_entities];
        }

        function make_valid_svg(svg_text) {
            return new DOMParser().parseFromString(svg_headers+'<g>'+svg_text+'</g></svg>', 'application/xml');
        }

        function assign_main_nums(entities_to_num, svg_text) {
            var raw_reg = new RegExp('--class.*?<!', 'g');
            var name_reg = new RegExp('--class.*?-->', 'g');
            var name;
            var entities_wrapper = make_valid_svg('');
            entities_wrapper.children[0].children[1].classList.add('entities_wrapper');
            var entity;


            svg_text.match(raw_reg).forEach(function(item, index) {
                name = item.match(name_reg)[0].replace(/--class |-->/g, '');

                entity = make_valid_svg(item.replace(/(--class.*-->)|<!/g, '')).children[0].children[1];
                entity.classList.add("entity");
                entity.dataset.num = entities_to_num[name].toString();

                entities_wrapper.children[0].children[1].appendChild(entity);
            });

            return entities_wrapper;
        }

        function assign_link_nums(entities_to_num, svg_text) {
            var raw_reg = new RegExp('--link.*?<!', 'g');
            var from_reg = new RegExp('--link.*?to', 'g');
            var to_reg = new RegExp('to.*?-->', 'g');
            var from_name, to_name;
            var links_wrapper = make_valid_svg('');
            links_wrapper.children[0].children[1].classList.add('links_wrapper');
            var link;


            svg_text.match(raw_reg).forEach(function(item, index) {
                from_name = item.match(from_reg)[0].replace(/--link | to/g, '');
                to_name = item.match(to_reg)[0].replace(/to |-->/g, '');

                link = make_valid_svg(item.replace(/(--class.*-->)|<!/g, '')).children[0].children[1];
                link.classList.add("link");

                if (entities_to_num.hasOwnProperty(from_name) && entities_to_num.hasOwnProperty(from_name)) {
                    link.classList.add(entities_to_num[from_name]);
                    link.classList.add(entities_to_num[to_name]);
                    links_wrapper.children[0].children[1].appendChild(link);
                }
            });

            return links_wrapper;
        }
    </script>

    <!-- 3. Поведение SVG -->
    <script>
        let SCALE_STEP = 0.1;

        let fit_btn = document.getElementsByClassName('fit')[0];
        let reset_btn = document.getElementsByClassName('reset')[0];
        var scale_factor = 1;
        var entities;
        var links;

        diagram_area.onwheel = zoom_diagram;
        fit_btn.onclick = fit;
        reset_btn.onclick = show_all;
        bind_keyboard();

        // TODO: Реализовать относительно курсора
        // FIX: Проблема при отдалении
        function zoom_diagram(event) {
            if (diagram_svg) {
                var abs_coords = get_cur_coords_on_svg(event);
                var old_coords = [Math.ceil(abs_coords[0]*-scale_factor), Math.ceil(abs_coords[1]*-scale_factor)];

                if (event.deltaY < 0) {
                    scale_factor += SCALE_STEP;
                } else {
                    scale_factor -= SCALE_STEP;
                }
                diagram_svg.style.transform = 'scale('+scale_factor+')';

                var new_coords = [Math.ceil(old_coords[0]*-SCALE_STEP), Math.ceil(old_coords[1]*-SCALE_STEP)];

                // console.log('abs:', abs_coords, 'old:', old_coords, 'new:', new_coords);
                // console.log(diagram_svg.style.transformOrigin);
                // diagram_svg.style.transformOrigin = new_coords[0] +'px ' + new_coords[1] +'px 0';
                // diagram_svg.style.left = abs_coords[0] +'px';
                // diagram_svg.style.top = abs_coords[1] +'px';
                diagram_svg.style.left = -parseInt(diagram_svg.style.width*scale_factor)/2 +'px';
                diagram_svg.style.top = -parseInt(diagram_svg.style.height*scale_factor)/2 +'px';
                event.preventDefault();
            }
        }

        function get_cur_coords_on_svg(event) {
            var rect = diagram_svg.getBoundingClientRect();
            var x = Math.ceil(event.clientX - rect.left);
            var y = Math.ceil(event.clientY - rect.top);
            return [x, y];
        }

        function fit() {
            if (diagram_svg) {
                var scale_hight = diagram_area.clientHeight / (diagram_svg.clientHeight+20);
                var scale_width = diagram_area.clientWidth / (diagram_svg.clientWidth+20);

                scale_factor = (scale_hight < scale_width) ? scale_hight : scale_width;
                diagram_svg.style.transform = 'scale('+scale_factor+')';
                diagram_svg.style.transformOrigin = '0 0 0';
                diagram_svg.style.left = 0;
                diagram_svg.style.top = 0;
            }
        }

        function bind_keyboard() {
            document.onkeyup = function(event) {
                switch (event.which) {
                    case 82:
                        show_all();
                        break;
                    case 70:
                        fit();
                        break;
                    default:
                        break;
                }
            };
        }

        function bind_controls() {
            bind_pan();
            bind_highlight();
        }

        function get_cursor_coords(event) {
            event = event || window.event;

            var pageX = event.pageX;
            var pageY = event.pageY;

            // IE 8
            if (pageX === undefined) {
                pageX = event.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                pageY = event.clientY + document.body.scrollTop + document.documentElement.scrollTop;
            }

            // console.log(pageX, pageY);
            return [pageX, pageY];
        }

        function bind_pan() {
            let PAN_SPEED = 0.3;
            let MIN_STEP = 0;
            var panner = (function () {
                var last_coords = [0,0];
                var new_coords;
                var is_panning = false;
                var delta_x, delta_y;

                return {
                    start_pan: function (event) {
                        last_coords = get_cursor_coords();
                        is_panning = true;
                    },

                    stop_pan: function (event) {
                        is_panning = false;
                    },

                    while_pan: function (event) {
                        if (is_panning) {
                            new_coords = get_cursor_coords();
                            delta_x = last_coords[0] - new_coords[0];
                            delta_y = last_coords[1] - new_coords[1];
                            if (delta_x > MIN_STEP || delta_x < -MIN_STEP || delta_y > MIN_STEP || delta_y < -MIN_STEP) {
                                diagram_svg.style.left = (parseInt(diagram_svg.style.left) - delta_x) + 'px';
                                diagram_svg.style.top = (parseInt(diagram_svg.style.top) - delta_y) + 'px';
                            last_coords = get_cursor_coords();
                            }
                        }
                    }
                };
            } ());

            diagram_area.addEventListener('mousedown', panner.start_pan);
            diagram_area.addEventListener('mousemove', panner.while_pan);
            diagram_area.addEventListener('mouseup', panner.stop_pan);
            diagram_area.addEventListener('mouseout', panner.stop_pan);
        }

        function bind_highlight() {
            entities = Array.from(document.getElementsByClassName('entity'));
            links = Array.from(document.getElementsByClassName('link'));
            add_links_to_main(entities, links);

            entities.forEach(function(item, index) {
                item.onclick = function(event) {
                    hide_all();
                    var num = this.dataset.num;
                    var siblings = Array.from(document.getElementsByClassName(num));
                    var selected_elems = Array.from(document.querySelectorAll('[data-num="'+num+'"]'));

                    siblings.forEach(function(item, index) {
                        item.classList.add('sibling');
                        item.classList.remove('hidden');
                    });

                    selected_elems.forEach(function(item, index) {
                        item.classList.add('selected');
                        item.classList.remove('hidden');
                    });
                }
            });
        }

        function add_links_to_main(entities, links) {
            var from_num, to_num, entity;
            var links_dict = Object();

            links.forEach(function(item, index) {
                from_num = item.classList[1];
                to_num = item.classList[2];
                if (!links_dict[from_num]) {
                    links_dict[from_num] = Array();
                }
                links_dict[from_num].push(to_num);
                if (!links_dict[to_num]) {
                    links_dict[to_num] = Array();
                }
                links_dict[to_num].push(from_num);
            });

            for (var num in links_dict) {
                if (links_dict.hasOwnProperty(num)) {
                    Array.from(document.querySelectorAll('[data-num="'+num+'"]')).forEach(function(entity, index) {
                        links_dict[num].forEach(function(item, index) {
                            entity.classList.add(item);
                        });
                    });
                }
            }
        }

        function hide_all() {
            if (entities && links) {
                entities.forEach(function(item, index) {
                    item.classList.add('hidden');
                    item.classList.remove('sibling');
                    item.classList.remove('selected');
                });
                links.forEach(function(item, index) {
                    item.classList.add('hidden');
                    item.classList.remove('sibling');
                    item.classList.remove('selected');
                });
            }
        }

        function show_all() {
            if (entities && links) {
                entities.forEach(function(item, index) {
                    item.classList.remove('hidden');
                    item.classList.remove('sibling');
                    item.classList.remove('selected');
                });
                links.forEach(function(item, index) {
                    item.classList.remove('hidden');
                    item.classList.remove('sibling');
                    item.classList.remove('selected');
                });
            }
        }
    </script>
</body>
</html>