<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подсветка для диаграмм сущностей PlantUML</title>
</head>
<body>
    <style>
        * {box-sizing: border-box;}
        body {margin: 0; padding: 10px 20px 40px 20px; background: #3E3E3E; color: #FFFFFF;}
        h1 {font-family: "Times New Roman", Times, serif; font-size: 24px; text-align: center; margin: 0 0 25px 0;}
        button {font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-weight: bold; background: #3D8DCA; padding: 7px 12px; cursor: pointer; color: #FFFFFF; border: solid 1px #3D8DCA; border-radius: 6px; min-width: 40px; min-height: 35px; margin-right: 5px; display: inline-block; vertical-align: middle;}
        button:hover:not(:disabled) {border-color: #FFFFFF}
        button:disabled {background: #8C9093; border-color: #8C9093; cursor: not-allowed;}
        button svg {width: 15px; vertical-align: middle;}

        .controls {margin-bottom: 10px;}
        section.upload {margin-bottom: 25px;}
        input.file {display: none;}
        textarea {resize: none; background: #696969; color: #FFFFFF; width: 100%; height: 30vh; border: solid 1px #000000; padding: 10px; border-radius: 10px;}
        span.file-name.error {color: #DC5C55;}
        section.view .diagram {position: relative; background: #D1D1D1; width: 100%; height: 86vh; border: solid 1px #000000; border-radius: 10px; padding: 10px; overflow: auto;}
        section.view .diagram svg {position: absolute; left: 0; top: 10px; transform-origin: 0 0;}

        footer {font-size: 14px; text-align: right; width: 100%; margin: 12px 0px; position: absolute; right: 20px;}

        .handicap-msg {position: fixed; background: rgba(0,0,0,0.9); left: 0; top: 0; width: 100vw; height: 100vh; z-index: 1; text-align: center; font-size: 30px;}
    </style>

    <main>
        <noscript>
            <div class="handicap-msg">
                <p>
                    Инструмент работает на JavaScript. <br>
                    Пожалуйста включите JavaScript.
                </p>
            </div>
        </noscript>

        <h1>Подсветка для диаграмм сущностей PlantUML</h1>
        <section class="upload">
            <div class="controls">
                <input type="file" name="svg-src" class="file">
                <button class="svg-btn">SVG</button>
                <span class="file-name error">Файл не выбран</span>
            </div>
            <textarea name="code" class="code" cols="30" rows="10" readonly></textarea>
        </section>
        <section class="view">
            <div class="controls">
                <button class="zoom-in" disabled>
                    <svg width="100%" height="100%" viewBox="0 0 15 15" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"><g transform="matrix(1,0,0,1,-47.5194,-283.391)"><g transform="matrix(1,0,0,1,2.56803,19.802)"><g transform="matrix(0.942984,0,0,1.04763,-188.926,-36.5134)"><rect x="254.381" y="286.459" width="3.181" height="14.318" style="fill:white;"/></g><g transform="matrix(5.77411e-17,0.942984,-1.04763,6.41487e-17,360.054,29.7117)"><rect x="254.381" y="286.459" width="3.181" height="14.318" style="fill:white;"/></g></g></g></svg>
                </button>
                <button class="zoom-out" disabled>
                    <svg width="100%" height="100%" viewBox="0 0 15 3" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;"><g transform="matrix(1,0,0,1,-87.4211,-289.391)"><g transform="matrix(5.77411e-17,0.942984,-1.04763,6.41487e-17,402.524,49.5137)"><rect x="254.381" y="286.459" width="3.181" height="14.318" style="fill:white;"/></g></g></svg>
                </button>
                <button class="fit" disabled>Вместить</button>
                <button class="reset" disabled>Сбросить выделение</button>
            </div>
            <div class="diagram"></div>
        </section>
    </main>
    <footer>
        <span class="copyright">© 2019 Аксанов К. В.</span>
    </footer>

    <!-- Уведомление о поддержке API -->
    <script>
        if (window.File && window.FileReader && window.FileList && window.Blob) {
        } else {
            var msg = document.createElement("p");
            msg.appendChild(document.createTextNode("Ваш браузер не поддерживает API для работы с файлами. Погуглите."));

            var api_missing_wrapper = document.createElement("div");
            api_missing_wrapper.appendChild(msg);
            api_missing_wrapper.classList.add("handicap-msg");

            document.body.appendChild(api_missing_wrapper);
        }
    </script>

    <!-- 1. Загрузка SVG -->
    <script>
        let LOADING_STR = 'Идет загрузка...';
        let ERROR_STR = 'Ошибка загрузки.';

        let file_input = document.getElementsByClassName('file')[0];
        let svg_btn = document.getElementsByClassName('svg-btn')[0];
        let filename_label = document.getElementsByClassName('file-name')[0];
        let code_area = document.getElementsByClassName('code')[0];
        let diagram_area = document.getElementsByClassName('diagram')[0];
        let reader = new FileReader();
        var current_file;
        var diagram_code;
        var svg_text;
        var diagram_svg;

        reader.onloadstart = function(event) {
            code_area.innerText = LOADING_STR;
        };
        reader.onloadend = function(event) {
            try {
                raw_text = event.target.result;
                diagram_code = get_diagram_code(raw_text);
                svg_text = get_svg(raw_text);

                code_area.innerHTML = diagram_code;
                diagram_area.innerHTML = '';
                diagram_area.appendChild(parse_diagram(diagram_code, svg_text));
                diagram_svg = diagram_area.childNodes[0];
                bind_highlight();
                fit();
            }
            catch(err) {
                show_error();
            }
        };
        reader.onerror = show_error;

        file_input.addEventListener('change', select_file, false);
        svg_btn.onclick = function(event) {file_input.click();};

        function select_file(event) {
            current_file = event.target.files[0];
            var output = [];

            size = ((current_file.size/1024).toFixed(2) + ' Кб') || '';
            upd_date = new Date(current_file.lastModified);
            upd_date = current_file.lastModified ? (', ' + upd_date.toLocaleTimeString() + ' - ' + upd_date.toLocaleDateString()) : ''

            output.push(current_file.name + ' (' + size + upd_date +')');

            if (current_file.type != "image/svg+xml") {
                show_error();
            } else {
                hide_error();
                reader.readAsText(current_file);
            }
            filename_label.innerText = output;
        }

        function get_diagram_code(raw_text) {
            raw_text = raw_text.replace(/- -/g, "--");
            raw_text = raw_text.replace(/\. \./g, "..");
            let start_ind = raw_text.indexOf('@startuml');
            let end_ind = raw_text.indexOf('@enduml')+7;
            if (start_ind !== -1 && end_ind !== -1) {
                hide_error();
                return raw_text.substring(start_ind, end_ind);
            } else {
                show_error();
                return ERROR_STR;
            }
        }

        function get_svg(raw_text) {
            let start_ind = raw_text.indexOf('<svg');
            let end_ind = raw_text.indexOf('</svg>')+6;
            if (start_ind !== -1 && end_ind !== -1) {
                hide_error();
                return raw_text.substring(start_ind, end_ind);
            } else {
                show_error();
            }
        }

        function show_error() {
            filename_label.classList.add("error");
            code_area.innerText = ERROR_STR;
            diagram_area.innerHTML = '';
            zoom_in_btn.setAttribute('disabled', true);
            zoom_out_btn.setAttribute('disabled', true);
            fit_btn.setAttribute('disabled', true);
            reset_btn.setAttribute('disabled', true);
        }

        function hide_error() {
            filename_label.classList.remove("error");
            zoom_in_btn.removeAttribute('disabled');
            zoom_out_btn.removeAttribute('disabled');
            fit_btn.removeAttribute('disabled');
            reset_btn.removeAttribute('disabled');
        }
    </script>

    <!-- 2. Парсинг диаграммы -->
    <script>
        let svg_headers;
        var entities_to_num, num_to_entities;

        function parse_diagram(diagram_code, svg_text) {
            // 0. Получить необходимые заголовки для парсинга DOMParser
            svg_headers = get_svg_headers(svg_text);

            // 1. Узнать имена сущностей и сопоставить с числами (от нуля) - парсинг текста описания диаграммы
            [entities_to_num, num_to_entities] = get_entities(diagram_code);

            // 2. Добавить сущностям числа их имен - парсинг текста svg
            var entities_wrapper = assign_main_nums(entities_to_num, svg_text);

            // 3. Сопоставить связям числа имен сущностей - парсинг текста svg
            var links_wrapper = assign_link_nums(entities_to_num, svg_text);

            // 4. Объединить обертки сущностей и связей
            var diagram_svg = entities_wrapper.children[0];
            diagram_svg.appendChild(links_wrapper.children[0].children[1]);

            return diagram_svg;
        }

        function get_svg_headers(svg_text) {
            return svg_text.match(/<svg.*?<\/defs>/g);
        }

        function get_entities(diagram_code) {
            var reg = new RegExp('(class|entity|enum) [^\{]*', 'g');
            var num_to_entities = Object();
            var entities_to_num = Object();

            diagram_code.match(reg).forEach(function(item, index) {
                var entity = item.replace(/class|entity|enum|\s/g, '');
                num_to_entities['e'+index.toString()] = item;
                entities_to_num[entity] = 'e'+index.toString();
            });

            return [entities_to_num, num_to_entities];
        }

        function make_valid_svg(svg_text) {
            return new DOMParser().parseFromString(svg_headers+'<g>'+svg_text+'</g></svg>', 'application/xml');
        }

        function assign_main_nums(entities_to_num, svg_text) {
            var raw_reg = new RegExp('--class.*?<!', 'g');
            var name_reg = new RegExp('--class.*?-->', 'g');
            var name;
            var entities_wrapper = make_valid_svg('');
            entities_wrapper.children[0].children[1].classList.add('entities_wrapper');
            var entity;


            svg_text.match(raw_reg).forEach(function(item, index) {
                name = item.match(name_reg)[0].replace(/--class |-->/g, '');

                entity = make_valid_svg(item.replace(/(--class.*-->)|<!/g, '')).children[0].children[1];
                entity.classList.add("entity");
                entity.dataset.num = entities_to_num[name].toString();

                entities_wrapper.children[0].children[1].appendChild(entity);
            });

            return entities_wrapper;
        }

        function assign_link_nums(entities_to_num, svg_text) {
            var raw_reg = new RegExp('--link.*?<!', 'g');
            var from_reg = new RegExp('--link.*?to', 'g');
            var to_reg = new RegExp('to.*?-->', 'g');
            var from_name, to_name;
            var links_wrapper = make_valid_svg('');
            links_wrapper.children[0].children[1].classList.add('links_wrapper');
            var link;


            svg_text.match(raw_reg).forEach(function(item, index) {
                from_name = item.match(from_reg)[0].replace(/--link | to/g, '');
                to_name = item.match(to_reg)[0].replace(/to |-->/g, '');

                link = make_valid_svg(item.replace(/(--class.*-->)|<!/g, '')).children[0].children[1];
                link.classList.add("link");
                link.classList.add(entities_to_num[from_name].toString());
                link.classList.add(entities_to_num[to_name].toString());

                links_wrapper.children[0].children[1].appendChild(link);
            });

            return links_wrapper;
        }
    </script>

    <!-- 3. Поведение SVG -->
    <script>
        let SCALE_STEP = 0.1;

        let zoom_in_btn = document.getElementsByClassName('zoom-in')[0];
        let zoom_out_btn = document.getElementsByClassName('zoom-out')[0];
        let fit_btn = document.getElementsByClassName('fit')[0];
        let reset_btn = document.getElementsByClassName('reset')[0];
        var scale_factor = 1;
        var entities;
        var links;

        zoom_in_btn.onclick = zoom_in;
        zoom_out_btn.onclick = zoom_out;
        fit_btn.onclick = fit;
        reset_btn.onclick = show_all;

        function zoom_in() {
            if (diagram_svg) {
                scale_factor += SCALE_STEP;
                diagram_svg.style.transform = 'scale('+scale_factor+')';
            }
        }

        function zoom_out() {
            if (diagram_svg) {
                scale_factor -= SCALE_STEP;
                diagram_svg.style.transform = 'scale('+scale_factor+')';
            }
        }

        function fit() {
            if (diagram_svg) {
                var scale_hight = diagram_area.clientHeight / (diagram_svg.clientHeight+20);
                var scale_width = diagram_area.clientWidth / (diagram_svg.clientWidth+20);

                scale_factor = (scale_hight < scale_width) ? scale_hight : scale_width;
                diagram_svg.style.transform = 'scale('+scale_factor+')';
            }
        }

        function bind_highlight() {
            entities = Array.from(document.getElementsByClassName('entity'));
            links = Array.from(document.getElementsByClassName('link'));
            add_links_to_main(entities, links);

            entities.forEach(function(item, index) {
                item.onclick = function(event) {
                    hide_all();
                    var num = this.dataset.num;
                    var siblings = Array.from(document.getElementsByClassName(num));
                    siblings.forEach(function(item, index) {
                        item.style.opacity = 1;
                    });
                    this.style.opacity = 1;
                }
            });
        }

        function add_links_to_main(entities, links) {
            var from_num, to_num, entity;
            var links_dict = Object();

            links.forEach(function(item, index) {
                from_num = item.classList[1];
                to_num = item.classList[2];
                if (!links_dict[from_num]) {
                    links_dict[from_num] = Array();
                }
                links_dict[from_num].push(to_num);
                if (!links_dict[to_num]) {
                    links_dict[to_num] = Array();
                }
                links_dict[to_num].push(from_num);
            });

            for (var num in links_dict) {
                if (links_dict.hasOwnProperty(num)) {
                    Array.from(document.querySelectorAll('[data-num="'+num+'"]')).forEach(function(entity, index) {
                        links_dict[num].forEach(function(item, index) {
                            entity.classList.add(item);
                        });

                    });
                }
            }
        }

        function hide_all() {
            if (entities && links) {
                entities.forEach(function(item, index) {
                    item.style.opacity = 0.2;
                });
                links.forEach(function(item, index) {
                    item.style.opacity = 0.2;
                });
            }
        }

        function show_all() {
            if (entities && links) {
                entities.forEach(function(item, index) {
                    item.style.opacity = 1;
                });
                links.forEach(function(item, index) {
                    item.style.opacity = 1;
                });
            }
        }

        document.onkeyup = function(event) {
            switch (event.which) {
                case 109:
                    zoom_out();
                    break;
                case 107:
                    zoom_in();
                    break;
                case 82:
                    show_all();
                    break;
                case 70:
                    fit();
                    break;
                default:
                    break;
            }
        };
    </script>
</body>
</html>